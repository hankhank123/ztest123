/*
 * Copyright (C) 2009-2018 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("cus.o2c.billplan.manage.s1.ext.controller.ObjectPageExt",{_getCrossAppNavigator:function(){var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;return f&&f("CrossApplicationNavigation");},onInit:function(){var t=this;this.getView().setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"messages");this.byId("Items::Table").getTable().attachSelectionChange(function(){t.updateItemActionButtonsState();});},onAfterRendering:function(){var t=this;var s=["idCopyItem","idCreateItem","idTerminateItem","idFollowOnItem","idExceptionItem","idDeleteItem"];for(var i=0;i<s.length;i++){var b=this.getView().byId(s[i]);if(b){b.bindProperty("visible",{path:"ui>/editable"});}}var c=this.byId("idCreateItem");if(c){c.bindProperty("enabled",{path:"ui>/editable",formatter:function(){var o=t.getView().getBindingContext();if(typeof o==="undefined"){return true;}var a=o.getModel().getData(o.sPath);if(typeof a==="undefined"){return true;}if(a.CABillgPlnStatus==="X"||a.CABillgPlnStatus==="F"){return false;}else{return true;}}});}this.byId("Items::Table").getTable().bindProperty("mode",{path:"ui>/editable",formatter:function(p){return p?"SingleSelectLeft":"None";}});this.byId("BillableItems::Table").getTable().bindProperty("mode",{path:"ui>/editable",formatter:function(p){return"None";}});this.byId("Reference::Table").getTable().bindProperty("mode",{path:"ui>/editable",formatter:function(p){return"None";}});this.createMessagePopover();this.getView().getModel().attachBatchRequestSent(function(){sap.ui.getCore().getMessageManager().removeAllMessages();t.oMessagePopover.close();t.oBtnMsgPopover.setVisible(false);});this.getView().getModel().attachBatchRequestCompleted(function(){t.updateItemActionButtonsState();});},updateItemActionButtonsState:function(){var c=this.byId("idCreateItem");var a=this.byId("idCopyItem");var t=this.byId("idTerminateItem");var f=this.byId("idFollowOnItem");var e=this.byId("idExceptionItem");var d=this.byId("idDeleteItem");var b=[c,a,t,f,e,d];var g=this.byId("Items::Table").getTable().getSelectedContexts()[0];if(typeof g==="undefined"){return;}var h=g.getModel().getData(g.sPath);if(typeof h==="undefined"){return;}var o=this.getView().getBindingContext();var j=o.getModel().getData(o.sPath);var k=[];switch(j.CABillgPlnStatus){case"":case"O":k=[c,e,d,a];break;case"R":switch(h.CABillgPlnItemStatus){case"":k=[c,e,d,a];break;case"O":case"R":k=[c,e,t,f];break;case"F":default:k=[];break;}break;case"X":case"F":default:k=[];break;}if(h.CABillgPlnItmCat==="BIP02"){var l=k.indexOf(e);if(l>-1){k.splice(l,l);}}var m=$(b).not(k).get();for(var i=0;i<k.length;i++){if(!(typeof k[i]==="undefined")){k[i].setProperty("enabled",true);}}for(var i=0;i<m.length;i++){if(!(typeof m[i]==="undefined")){m[i].setProperty("enabled",false);}}},onCreateItemPress:function(E){var t=this;var f="cus.o2c.billplan.manage.s1.ext.fragments.CreateBillingPlanItem";var m=this.getView().getModel();var p=this.getView().getBindingContext().getPath()+"/to_CABillgPlnItem";var o=this.extensionAPI;var i=this.getView().getModel("i18n").getResourceBundle();var d=this.getView().getBusyIndicatorDelay();this.getView().setBusyIndicatorDelay(0).setBusy(true).setBusyIndicatorDelay(d);var s=function(r){t.getView().setBusy(false);if(!r){return;}var c=new sap.ui.model.Context(m,r.context.sPath);var _=sap.ui.xmlfragment(t.getView().getId(),f,{onCreatePress:function(e){var b=t.getView().byId("idFieldItemType");var v=b.getValue();if(!v.length){b.setValueState("Error");return;}_.setBusyIndicatorDelay(0).setBusy(true);m.read("/I_CABillgPlnItmType",{filters:[new sap.ui.model.Filter("CABillgPlnItmType",sap.ui.model.FilterOperator.EQ,v)],success:function(g,h){if(g.results.length!==1){b.setValueState("Error");b.setValueStateText(i.getText("unknownItemType"));_.setBusy(false);return;}m.refresh(true);_.close();t._handleMessageButton(t);},error:function(g){_.setBusy(false);t._handleMessageButton(t);}});},onCancelPress:function(e){m.remove("",{context:c,success:function(){m.refresh(true);_.close();t._handleMessageButton(t);},error:function(){t._handleMessageButton(t);}});},afterClose:function(){_.destroy();}});_.setBindingContext(c);o.attachToView(_);_.open();m.refresh(true);t._handleMessageButton(t);};var a=function(e){t.getView().setBusy(false);t._handleMessageButton(t);};var D=new sap.ui.generic.app.transaction.DraftController(m);D.createNewDraftEntity(p,p).then(s).catch(a);},onCopyItemPress:function(){this._manageItem("C_CABillgPlnItemCopy");},onTerminateItemPress:function(){this._manageItem("C_CABillgPlnItemTerminate");},onFollowOnItemPress:function(){this._manageItem("C_CABillgPlnItemFollowonitem");},_manageItem:function(p){var t=this;var m=this.getView().getModel();var c=this.byId("Items::Table").getTable().getSelectedContexts()[0];var e=c.getModel().getData(c.sPath);m.createEntry(p,{urlParameters:{"CABillgPlnNumber":"'"+e.CABillgPlnNumber.toString()+"'","CABillgPlnItem":"'"+e.CABillgPlnItem.toString()+"'","DraftUUID":"guid'"+e.DraftUUID+"'","IsActiveEntity":e.IsActiveEntity},success:function(r){m.refresh(true);t._handleMessageButton(t);},error:function(r){t._handleMessageButton(t);}});m.submitChanges();},onExceptionItemPress:function(e){var t=this;var m=this.getView().getModel();var c=this.byId("Items::Table").getTable().getSelectedContexts()[0];var a=c.getModel().getData(c.sPath);m.createEntry("C_CABillgPlnItemException",{urlParameters:{"CABillgPlnNumber":"'"+a.CABillgPlnNumber.toString()+"'","CABillgPlnItem":"'"+a.CABillgPlnItem.toString()+"'","DraftUUID":"guid'"+a.DraftUUID+"'","IsActiveEntity":a.IsActiveEntity},success:function(r){m.refresh(true);t._handleMessageButton(t);},error:function(r){t._handleMessageButton(t);}});m.submitChanges();},onDeleteItemPress:function(e){var t=this;var m=this.getView().getModel();var c=this.byId("Items::Table").getTable().getSelectedContexts()[0];var s=function(){m.refresh(true);t._handleMessageButton(t);};var a=function(){t._handleMessageButton(t);};m.remove(c.sPath,{context:c,success:s,error:a});},onClickBIT:function(e){var c=e.getSource().getBindingContext();var C=this._getCrossAppNavigator();var h;if(e.getSource().getParent().getParent().getTable().getSelectedContexts().length===0){h=C.hrefForExternal({target:{semanticObject:"BillableItem",action:"display"},params:{GPART:c.getObject().BusinessPartner,VKONT:c.getObject().ContractAccount}});}else{var p=e.getSource().getParent().getParent().getTable().getSelectedContexts()[0].getPath();var s=e.getSource().getModel().getProperty(p+"/SRCTAID");var b=e.getSource().getModel().getProperty(p+"/BITPACKUUID");var B=e.getSource().getModel().getProperty(p+"/BITPACKCNO");h=C.hrefForExternal({target:{semanticObject:"BillableItem",action:"display"},params:{GPART:c.getObject().BusinessPartner,VKONT:c.getObject().ContractAccount,SRCTAID:s,BITPACKUUID:b,BITPACKCNO:B}});}C.toExternal({target:{shellHash:h}});},createMessagePopover:function(){var t=this;this.oMessagePopover=new sap.m.MessagePopover({items:{path:"messages>/",template:new sap.m.MessagePopoverItem({description:"{messages>description}",type:"{messages>type}",title:"{messages>message}"})}});this.extensionAPI.attachToView(this.oMessagePopover);this.oFooter=this.getView().byId("template::ObjectPage::FooterToolbar");this.oBtnMsgPopover=new sap.m.Button({icon:"sap-icon://message-popup",type:"Emphasized"});this.oFooter.insertContent(this.oBtnMsgPopover,0);this.oBtnMsgPopover.bindProperty("text",{path:"messages>/",formatter:function(p){return p.length?p.length.toString():"";}});this.oBtnMsgPopover.setVisible(false);this.oBtnMsgPopover.addEventDelegate({onAfterRendering:function(){t._handleMessagePopover(t);}});this.oBtnMsgPopover.attachPress(function(e){t.oMessagePopover.toggle(e.getSource());});},_removeDuplicateMessages:function(){var m=sap.ui.getCore().getMessageManager().getMessageModel().getData();var u=[];for(var i=0;i<m.length;i++){if(u.indexOf(m[i].message)<0){u.push(m[i].message);}else{sap.ui.getCore().getMessageManager().removeMessages([m[i]]);}}},_handleMessageButton:function(c){this._removeDuplicateMessages();if(sap.ui.getCore().getMessageManager().getMessageModel().getData().length){this.oBtnMsgPopover.setVisible(true);}else{if(!(typeof this.oBtnMsgPopover==="undefined")){this.oBtnMsgPopover.setVisible(false);}}},_handleMessagePopover:function(c){var m=sap.ui.getCore().getMessageManager().getMessageModel().getData();for(var i=0;i<m.length;i++){if(m[i].type==="Error"){c.oMessagePopover.openBy(c.oBtnMsgPopover);return;}}}});
